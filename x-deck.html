<template id="deck">
  <style>
    ::content x-slide {
      display: none;
    }

    ::content x-slide.active {
      display: block;
    }

    .deck {
      width:  100%;
      height: 100%;
    }

    @media print {
      ::content x-slide {
        display: block;
        position: relative;
        max-width: 29.7cm;
        height: 15cm;
        padding: 2cm;
        margin: 1cm auto;
        page-break-after: always;
        overflow: hidden;
      }
    }
  </style>
  <div>
    <content></content>
  </div>
</template>

<script>
  var XDeck = undefined;

  (function() {
    var localDoc = document.currentScript.ownerDocument;
    var proto = Object.create(HTMLElement.prototype);

    proto.createdCallback = function() {
      this._root = this.createShadowRoot();

      var tplContent = localDoc.querySelector("template#deck").content;
      this._root.appendChild(tplContent.cloneNode(true));
    };

    var changeSlide = function(direction) {
        var currentSlideIndex = parseInt(document.location.hash.slice(1), 10) || 1;
        var slideShown     = document.querySelector("x-slide.active"),
            slideToBeShown = slideShown;
            
        var transitFunc = (direction == "next" ? function(node) { return node.nextSibling;     } 
                                               : function(node) { return node.previousSibling; });
        
        while((slideToBeShown = transitFunc(slideToBeShown)) && slideToBeShown.tagName !== "X-SLIDE");

        if(!slideToBeShown) return;

        slideToBeShown.classList.add("active");
        slideShown.classList.remove("active");
        
    }

    var addKeyboardListener = function() {
      document.addEventListener("keyup", function(event) {
        var currentSlideIndex = parseInt(document.location.hash.slice(1), 10) || 1;

        if(event.keyCode == 37) {         // left
          document.location.hash = --currentSlideIndex;
          changeSlide("previous");
        } else if(event.keyCode == 39 ) { // right
          document.location.hash = ++currentSlideIndex;
          changeSlide("next");
        } else { return; }
      });
    }
    
    var addTouchListener = function() {
      var gestureStartX = 0;
      var MINMOVEX = 50;
      document.addEventListener("touchstart", function(event) {
        gestureStartX = event.changedTouches[0].pageX;
      });
      
      document.addEventListener("touchend", function(event) {
        var currentSlideIndex = parseInt(document.location.hash.slice(1), 10) || 1;
        if(event.changedTouches[0].pageX > gestureStartX + MINMOVEX) {
          // prev slide
          document.location.hash = ++currentSlideIndex;
          changeSlide("previous");

          event.stopPropagation()
        } else if(event.pageX < gestureStartX - MINMOVEX) {
          // next slide
          document.location.hash = ++currentSlideIndex;
          changeSlide("next");
          event.stopPropagation()
        }
      });
    }

    proto.attachedCallback = function() {
      var self = this;
      var currentSlideIndex = parseInt(document.location.hash.slice(1), 10) || 1;
      document.location.hash = "#" + currentSlideIndex;

      self.querySelector("x-slide:nth-child(" + currentSlideIndex + ")").classList.add("active");

      addKeyboardListener();
      addTouchListener();
    };

    XDeck = document.registerElement("x-deck", { prototype: proto });
  })();
</script>